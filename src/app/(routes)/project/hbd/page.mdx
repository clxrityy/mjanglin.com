import { SlashCommandIcon, TemplateIcon } from "./icons";

# [hbd](https://hbd.mjanglin.com) 
![hbd](/img/hbd_banner.gif)
 [hbd.mjanglin.com](https://hbd.mjanglin.com)

This is the updated version of the **hbd** bot. To view the original project built with discord.js, visit [this page](https://mjanglin.com/archive/hbd).

---

### Synopsis

- hbd is a dynamic Discord birthday bot that runs using [Edge Runtime](https://vercel.com/docs/functions/runtimes/edge-runtime).
- The [`discord-api-types`](https://discord-api-types.dev/) package is used to facilitate requests and responses to/from the [interactions endpoint](https://discord.com/developers/docs/interactions/slash-commands#receiving-an-interaction).
- A lot of typings and functions have been implemented to make this all work with OAuth2 functionality through the (sub)domain it's served on.
- [Prisma](https://www.prisma.io/) is used to manage data stored with [Vercel Postgres](https://vercel.com/docs/storage/vercel-postgres).
    - [Prisma Accelerate](https://www.prisma.io/data-platform/accelerate) is used to optimize edge performance.

---

### Template <TemplateIcon />
The initial template for a bot with edge functionality was created by [@jzxhuang](https://github.com/jzxhuang): 
- ##### [nextjs-discord-bot](https://github.com/jzxhuang/nextjs-discord-bot)

I built off his template to create *another* template that implements OAuth2 which you can use to create your own variation of this bot: 
- ##### [nextjs-discord-bot-with-oauth](https://github.com/clxrityy/nextjs-discord-bot-with-oauth) 
```zsh 
git clone https://github.com/clxrityy/nextjs-discord-bot-with-oauth.git 
```

---

### Commands <SlashCommandIcon />

#### Defining & Registering

Commands are defined as an `ApplicationCommand` type.

##### Application command type: ([reference](https://discord.com/developers/docs/interactions/application-commands))
```ts
export type ApplicationCommandOption = {
    type: number;
    name: string;
    // ...
}

export type ApplicationCommand = {
    name: string;
    description: string;
    options?: ApplicationCommandOption[];
    permissions?: number[];
}
```

##### Command definition example

```ts
import { ApplicationCommand } from "@/types/interactions";

const PING_COMMAND: ApplicationCommand = {
    name: "ping",
    description: "Replies with Pong!"
} as const;

export default PING_COMMAND;
```

Every command is exported in the primary `index.ts` file:

```ts
/**
 * @see https://discord.com/developers/docs/interactions/application-commands#registering-a-command
 */
import PING_COMMAND from "./misc/ping";

export const commands = {
    ping: PING_COMMAND,
}
```


To register commands, run the `pnpm register-commands` script.
```ts
import { commands } from "@/data/commands";
import { env } from "./env.mjs";
 /**
 * @see https://discord.com/developers/docs/interactions/application-commands#bulk-overwrite-global-application-commands
 */
async function main() {
    const reponse = await fetch(`http://discord.com/api/v10/applications/${env.CLIENT_ID}/commands`, 
    {
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bot ${env.BOT_TOKEN}`
        },
        method: "PUT",
        body: JSON.stringify(Object.values(commands))
    });
}
```

#### Interaction responses

The data from the interaction is parsed into an `InteractionData` interface:

```ts
export interface InteractionData {
    id: string;
    name: string;
    options?: InteractionSubcommand<InteractionOption>[] | InteractionOption[] | InteractionSubcommandGroup<InteractionSubcommand<InteractionOption>>[];
}
```